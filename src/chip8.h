#include <stdint.h>
#include "Arduino.h"

class Chip8 {
	private:
		uint8_t memory[4096] = {};
		uint16_t pc = 0x200;
		uint16_t I = 0;
		uint16_t stack[32] = {};
		uint8_t sp = 0;
		uint8_t delay_timer = 0;
		uint8_t sound_timer = 0;
		uint8_t V[16] = {};
		ulong last_tick = 0;
		const uint8_t fontset[80] {
			0xF0, 0x90, 0x90, 0x90, 0xF0,		// 0
			0x20, 0x60, 0x20, 0x20, 0x70,		// 1
			0xF0, 0x10, 0xF0, 0x80, 0xF0,		// 2
			0xF0, 0x10, 0xF0, 0x10, 0xF0,		// 3
			0x90, 0x90, 0xF0, 0x10, 0x10,		// 4
			0xF0, 0x80, 0xF0, 0x10, 0xF0,		// 5
			0xF0, 0x80, 0xF0, 0x90, 0xF0,		// 6
			0xF0, 0x10, 0x20, 0x40, 0x40,		// 7
			0xF0, 0x90, 0xF0, 0x90, 0xF0,		// 8
			0xF0, 0x90, 0xF0, 0x10, 0xF0,		// 9
			0xF0, 0x90, 0xF0, 0x90, 0x90,		// A
			0xE0, 0x90, 0xE0, 0x90, 0xE0,		// B
			0xF0, 0x80, 0x80, 0x80, 0xF0,		// C
			0xE0, 0x90, 0x90, 0x90, 0xE0,		// D
			0xF0, 0x80, 0xF0, 0x80, 0xF0,		// E
			0xF0, 0x80, 0xF0, 0x80, 0x80		// F
		};
		bool* keys;

		void unknown_opcode(uint16_t opcode) {
			Serial.printf("Unknown opcode: %#x\n", opcode);
			// pc += 2; // Uncomment if you want to skip unknown instructions instead of stopping the execution
		}

		const uint8_t key_map[16] {13, 0,1,2, 4,5,6, 8,9,10, 12,14,3,7,11,15};

	public:
		bool screen_drawn = false;
		bool playing_sound = false;
		bool screen[64*32] = {};
		Chip8(uint8_t* rom, size_t rom_size, bool* keys): keys(keys) {
			memcpy(memory,fontset,80);
			memcpy(memory+0x200,rom,rom_size);
		}
		void cycle();
};